name: Jira → In Review when Review Requested

on:
  pull_request:
    types: [review_requested]

permissions:
  contents: read
  pull-requests: read

jobs:
  mark_in_review:
    runs-on: ubuntu-latest
    steps:
      - name: Get Jira key from PR title
        id: key
        shell: bash
        run: |
          set -euo pipefail
          title="${{ github.event.pull_request.title }}"

          # Match ABC-123 style key in title
          if [[ "$title" =~ ([A-Z][A-Z0-9]+-[0-9]+) ]]; then
            echo "key=${BASH_REMATCH[1]}" >> "$GITHUB_OUTPUT"
          else
            echo "No Jira issue key found in PR title" >&2
            exit 1
          fi

      - name: Call Jira Automation webhook
        env:
          WEBHOOK_URL: ${{ secrets.JIRA_WEBHOOK_URL }}
          WEBHOOK_TOKEN: ${{ secrets.JIRA_WEBHOOK_TOKEN }}
          ISSUE_KEY: ${{ steps.key.outputs.key }}
        run: |
          set -euo pipefail
          echo "Marking $ISSUE_KEY In Review…"
          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -H "X-Automation-Webhook-Token: ${WEBHOOK_TOKEN}" \
            "${WEBHOOK_URL}?issue=${ISSUE_KEY}"
